#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$ROOT"

cmd="${1:-}"; shift || true
case "$cmd" in
  sanity)
    echo "pwd: $(pwd)"
    echo "node: $(node -v)"
    echo "npm: $(npm -v)"
    echo "git: $(git rev-parse --short HEAD 2>/dev/null || true)"
    ;;
  verify)
    npm run -s verify
    ;;
  run)
    f="${1:-}"; shift || true
    [[ -n "$f" ]] || { echo "Uso: mf run <arquivo.sh>"; exit 2; }
    [[ -f "$f" ]] || { echo "❌ não existe: $f"; exit 2; }
    bash "$f" "$@"
    ;;

  mk)
    # Cria um arquivo a partir do STDIN com caminho seguro:
    # uso: printf 'conteudo' | ./.mf_master/bin/mf mk path/do/arquivo
    out="${1:-}"; shift || true
    [[ -n "$out" ]] || { echo "Uso: mf mk <path>"; exit 2; }
    mkdir -p "$(dirname "$out")"
    cat > "$out"
    chmod +x "$out" 2>/dev/null || true
    echo "OK: wrote $out"
    ;;

  *)
    echo "Uso: mf {sanity|verify|run|mk}"
    exit 2
    ;;
esac
