     1 | import fs from "fs";
     2 | import path from "path";
     3 | 
     4 | const base = process.argv[2];
     5 | if (!base) throw new Error("Uso: node _merge_and_validate.mjs <base_dir>");
     6 | 
     7 | const prohibited = [
     8 |   "dor",
     9 |   "dores",
    10 |   "lesão",
    11 |   "lesoes",
    12 |   "reabilitação",
    13 |   "reabilitacao",
    14 |   "fisioterapia",
    15 |   "prevenção",
    16 |   "prevencao",
    17 |   "limitação",
    18 |   "limitacao",
    19 |   "clínica",
    20 |   "clinica"
    21 | ];
    22 | 
    23 | const TEMPLATE = {
    24 |   musculacao: {
    25 |     costas: { halteres: [], maquinas: [], cabos: [] },
    26 |     peito: { halteres: [], maquinas: [], cabos: [] },
    27 |     ombros: { halteres: [], maquinas: [], cabos: [] },
    28 |     biceps: { halteres: [], maquinas: [], cabos: [] },
    29 |     triceps: { halteres: [], maquinas: [], cabos: [] },
    30 |     gluteos: { halteres: [], maquinas: [], cabos: [] },
    31 |     quadriceps: { halteres: [], maquinas: [], cabos: [] },
    32 |     posterior_coxa: { halteres: [], maquinas: [], cabos: [] },
    33 |     panturrilhas: { halteres: [], maquinas: [], cabos: [] }
    34 |   }
    35 | };
    36 | 
    37 | function deepMerge(dst, src) {
    38 |   for (const k of Object.keys(src)) {
    39 |     if (src[k] && typeof src[k] === "object" && !Array.isArray(src[k])) {
    40 |       if (!dst[k] || typeof dst[k] !== "object" || Array.isArray(dst[k])) dst[k] = {};
    41 |       deepMerge(dst[k], src[k]);
    42 |     } else {
    43 |       dst[k] = src[k];
    44 |     }
    45 |   }
    46 |   return dst;
    47 | }
    48 | 
    49 | function readJSON(p) {
    50 |   const s = fs.readFileSync(p, "utf8");
    51 |   return JSON.parse(s);
    52 | }
    53 | 
    54 | function assert(cond, msg) {
    55 |   if (!cond) throw new Error("VALIDATION FAIL: " + msg);
    56 | }
    57 | 
    58 | function scanProhibited(obj, fileTag) {
    59 |   const s = JSON.stringify(obj).toLowerCase();
    60 |   for (const w of prohibited) {
    61 |     if (s.includes(w)) throw new Error(`PROIBIDO DETECTADO (${w}) em ${fileTag}`);
    62 |   }
    63 | }
    64 | 
    65 | function validateExercise(ex, where) {
    66 |   const keys = ["name","goal","execution","focus","cues","common_errors","variations"];
    67 |   for (const k of keys) assert(k in ex, `${where}: faltando campo "${k}"`);
    68 |   assert(typeof ex.name === "string" && ex.name.trim().length > 0, `${where}: name inválido`);
    69 |   assert(typeof ex.goal === "string" && ex.goal.trim().length > 0, `${where}: goal inválido`);
    70 |   assert(typeof ex.focus === "string" && ex.focus.trim().length > 0, `${where}: focus inválido`);
    71 | 
    72 |   for (const arrKey of ["execution","cues","common_errors","variations"]) {
    73 |     assert(Array.isArray(ex[arrKey]), `${where}: ${arrKey} não é array`);
    74 |     assert(ex[arrKey].length === 3, `${where}: ${arrKey} deve ter exatamente 3 itens`);
    75 |     for (const [i, v] of ex[arrKey].entries()) {
    76 |       assert(typeof v === "string" && v.trim().length > 0, `${where}: ${arrKey}[${i}] inválido`);
    77 |     }
    78 |   }
    79 | }
    80 | 
    81 | function validateFull(doc) {
    82 |   assert(doc && typeof doc === "object", "documento inválido");
    83 |   assert(doc.musculacao && typeof doc.musculacao === "object", "faltando musculacao");
    84 | 
    85 |   const groups = ["costas","peito","ombros","biceps","triceps","gluteos","quadriceps","posterior_coxa","panturrilhas"];
    86 |   const cats = ["halteres","maquinas","cabos"];
    87 | 
    88 |   for (const g of groups) {
    89 |     assert(doc.musculacao[g], `faltando grupamento: ${g}`);
    90 |     for (const c of cats) {
    91 |       assert(Array.isArray(doc.musculacao[g][c]), `faltando categoria ${g}.${c}`);
    92 |       assert(doc.musculacao[g][c].length > 0, `${g}.${c} está vazio (não permitido)`);
    93 |       doc.musculacao[g][c].forEach((ex, idx) => validateExercise(ex, `${g}.${c}[${idx}]`));
    94 |     }
    95 |   }
    96 | 
    97 |   scanProhibited(doc, "FULL_JSON");
    98 | }
    99 | 
   100 | const files = [
   101 |   "musculacao.block1.costas_peito.json",
   102 |   "musculacao.block2.ombros_biceps_triceps.json",
   103 |   "musculacao.block3.gluteos_quadriceps.json",
   104 |   "musculacao.block4.posterior_panturrilhas.json"
   105 | ].map(f => path.join(base, f));
   106 | 
   107 | for (const f of files) {
   108 |   assert(fs.existsSync(f), `arquivo não encontrado: ${f}`);
   109 | }
   110 | 
   111 | let out = JSON.parse(JSON.stringify(TEMPLATE));
   112 | for (const f of files) {
   113 |   const part = readJSON(f);
   114 |   scanProhibited(part, path.basename(f));
   115 |   out = deepMerge(out, part);
   116 | }
   117 | 
   118 | validateFull(out);
   119 | 
   120 | const outPath = path.join(base, "musculacao.full.json");
   121 | fs.writeFileSync(outPath, JSON.stringify(out, null, 2) + "\n", "utf8");
   122 | 
   123 | console.log("✅ MERGE OK | FULL JSON:", outPath);
