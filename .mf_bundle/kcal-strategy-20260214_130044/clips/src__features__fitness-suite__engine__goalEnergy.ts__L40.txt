     1 | export type GoalKey = "emagrecimento_estetica" | "hipertrofia" | "performance_longevidade";
     2 | 
     3 | export type ActivityLevel = "iniciante" | "intermediario" | "avancado";
     4 | 
     5 | // Heurística científica-operacional:
     6 | // - Emagrecimento: déficit moderado (evitar agressivo quando carga alta).
     7 | // - Hipertrofia: leve superávit.
     8 | // - Performance/Longevidade: manutenção/leve superávit conforme carga.
     9 | export function normalizeGoal(raw: unknown): GoalKey {
    10 |   const s = String(raw ?? "").toLowerCase();
    11 |   if (s.includes("hipert")) return "hipertrofia";
    12 |   if (s.includes("perform") || s.includes("longev")) return "performance_longevidade";
    13 |   return "emagrecimento_estetica";
    14 | }
    15 | 
    16 | // Estima kcal/semana do treino a partir de modalidades + nível.
    17 | // (MVP seguro: usa ranges por modalidade; depois refinamos com METs, peso, duração e pace.)
    18 | export type ModalityKey = "musculacao" | "funcional" | "corrida" | "bike_indoor" | "crossfit";
    19 | 
    20 | export function estimateTrainingKcalPerSession(mod: ModalityKey, level: ActivityLevel, pesoKg = 70): number {
    21 |   // base por sessão (45-60min). Ajuste por nível.
    22 |   const levelMult = level === "avancado" ? 1.25 : level === "intermediario" ? 1.1 : 0.95;
    23 | 
    24 |   // valores conservadores (kcal/sessão) para MVP (sem risco de superestimar)
    25 |   // depois substituiremos por METs + duração + pace real.
    26 |   const base =
    27 |     mod === "musculacao" ? 280 :
    28 |     mod === "funcional" ? 360 :
    29 |     mod === "corrida" ? 420 :
    30 |     mod === "bike_indoor" ? 380 :
    31 |     400; // crossfit
    32 | 
    33 |   // pequeno ajuste por peso
    34 |   const weightMult = Math.max(0.85, Math.min(1.25, pesoKg / 70));
    35 |   return Math.round(base * levelMult * weightMult);
    36 | }
    37 | 
    38 | export function computeObjectiveDeltaKcal(goal: GoalKey, getKcal: number, treinoKcalSemanal: number) {
    39 |   // carga semanal de treino em kcal:
    40 |   // usamos para evitar déficit agressivo quando treino alto (aderência + recuperação).
    41 |   const weeklyLoad = treinoKcalSemanal;
    42 | 
    43 |   if (goal === "hipertrofia") {
    44 |     // leve superávit: +5% a +12% do GET, limitado por carga.
    45 |     const pct = weeklyLoad >= 2500 ? 0.05 : 0.08;
    46 |     return Math.round(getKcal * pct);
    47 |   }
    48 | 
    49 |   if (goal === "performance_longevidade") {
    50 |     // manutenção/leve superávit: 0% a +6% do GET conforme carga.
    51 |     const pct = weeklyLoad >= 2500 ? 0.04 : 0.02;
    52 |     return Math.round(getKcal * pct);
    53 |   }
    54 | 
    55 |   // emagrecimento/estética:
    56 |   // déficit moderado: -10% a -20% do GET, MAS se treino alto, reduzir déficit para preservar performance.
    57 |   const pct = weeklyLoad >= 2500 ? -0.10 : -0.15;
    58 |   return Math.round(getKcal * pct);
    59 | }
    60 | 
    61 | export function computeFinalTargetCalories(params: {
    62 |   getKcal: number;
    63 |   goalRaw: unknown;
    64 |   level: ActivityLevel;
    65 |   daysSelected: string[];
    66 |   planByDay: Record<string, ModalityKey>;
    67 |   pesoKg?: number;
    68 | }) {
    69 |   const goal = normalizeGoal(params.goalRaw);
    70 |   const pesoKg = params.pesoKg ?? 70;
    71 | 
    72 |   const treinoKcalSemanal = (params.daysSelected ?? []).reduce((acc, dayKey) => {
    73 |     const mod = params.planByDay?.[dayKey];
    74 |     if (!mod) return acc;
    75 |     return acc + estimateTrainingKcalPerSession(mod, params.level, pesoKg);
    76 |   }, 0);
    77 | 
    78 |   const deltaObjetivo = computeObjectiveDeltaKcal(goal, params.getKcal, treinoKcalSemanal);
    79 | 
    80 |   // deltaTreino: aqui é só informativo (para transparência). O GET já inclui atividade média,
    81 |   // mas usamos treinoKcalSemanal para ajustar objetivo (acima) e para exibir no relatório.
    82 |   const deltaTreinoInfo = Math.round(treinoKcalSemanal / 7);
    83 | 
    84 |   const alvoFinal = Math.max(1200, Math.round(params.getKcal + deltaObjetivo)); // piso de segurança MVP
    85 |   return {
    86 |     goal,
    87 |     treinoKcalSemanal,
    88 |     treinoKcalDiaMedio: deltaTreinoInfo,
    89 |     deltaObjetivoKcal: deltaObjetivo,
    90 |     caloriasAlvoFinal: alvoFinal,
    91 |   };
    92 | }
